#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <signal.h>
#include <CImg.h>
#include "sources/CPU.h"

using namespace cimg_library;

bool go = 0;
unsigned char frame[120][120];
unsigned char colors[256][3] ={
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {235,230,219},{224,219,204},{212,205,183},{191,183,151},{167,158,113},{126,116, 56},{ 54, 47, 22},{  8, 10,  4},
    {235,225,177},{230,220,159},{214,206,113},{199,195, 75},{181,184, 56},{142,155, 49},{ 65, 98, 38},{ 32, 52, 36},
    {235,236,148},{225,233,126},{216,229, 93},{194,220, 73},{161,206, 56},{105,178, 45},{ 37,114, 29},{ 43, 94,  0},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {236,215,215},{223,199,199},{212,189,187},{197,174,165},{174,150,130},{131,103, 67},{ 44, 32, 14},{ 10, 11,  6},
    {243,212,195},{243,207,184},{233,188,151},{222,168,112},{210,147, 76},{190,109, 41},{139, 52, 38},{ 97, 12,  0},
    {250,220,166},{250,209,149},{251,200,120},{249,183, 68},{245,159, 34},{222,126, 43},{186, 80,  0},{160, 45,  0},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {238,211,226},{227,195,216},{214,180,201},{198,156,178},{176,123,149},{130, 67, 91},{ 35, 17, 19},{  6,  9,  8},
    {244,204,223},{245,197,217},{241,181,200},{231,158,176},{222,131,154},{204, 88,110},{158, 47, 47},{112, 10, 20},
    {255,199,235},{255,187,225},{255,176,209},{255,154,180},{255,116,142},{255, 52, 77},{213, 12,  0},{121,  0,  0},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {233,211,243},{218,195,237},{207,180,230},{188,156,215},{163,124,194},{115, 69,154},{ 31, 18, 57},{ 12, 10, 17},
    {245,200,243},{245,194,245},{237,175,238},{226,151,228},{215,124,216},{192, 80,195},{137, 45,153},{ 98, 60,128},
    {255,199,252},{255,184,252},{255,173,251},{255,146,246},{255,106,240},{255, 40,232},{213,  0,190},{136,  0,118},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {232,223,246},{218,205,243},{201,187,237},{181,166,227},{153,134,207},{104, 75,169},{ 49, 23, 83},{  9,  8, 19},
    {231,197,245},{223,189,245},{208,170,245},{192,149,239},{176,127,235},{137, 85,219},{ 66, 45,185},{ 47, 44,143},
    {248,198,255},{239,187,255},{229,178,255},{218,156,255},{203,122,255},{172, 65,255},{ 87,  0,242},{ 29,  0,188},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {203,214,240},{181,199,234},{153,184,224},{122,167,214},{ 85,137,194},{ 43, 82,156},{ 23, 23, 75},{ 11, 12, 30},
    {203,201,244},{192,197,245},{164,182,244},{129,163,238},{ 90,146,233},{ 40,105,218},{ 31, 43,182},{ 36, 37,133},
    {200,210,255},{183,202,255},{163,190,255},{139,176,255},{ 95,150,255},{ 32,104,255},{  0, 27,233},{  3,  0,190},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {192,220,222},{168,206,207},{135,193,191},{103,177,169},{ 59,149,137},{ 24, 95, 81},{ 10, 20, 29},{  4,  9, 13},
    {148,216,219},{128,215,214},{ 79,203,195},{ 41,193,176},{ 24,178,155},{ 18,143,105},{ 14, 71, 38},{ 17, 36, 35},
    {102,235,234},{ 67,233,227},{ 34,228,218},{ 19,218,205},{ 15,198,184},{  0,183,152},{  0,139,109},{  0,103, 64},
    {255,255,255},{217,217,217},{178,178,178},{143,143,143},{107,107,107},{ 71, 71, 71},{ 36, 36, 36},{  0,  0,  0},
    {212,215,202},{192,199,182},{172,184,159},{151,166,128},{117,136, 89},{ 56, 81, 40},{  4, 40, 26},{  0, 10,  6},
    {192,210,174},{185,206,161},{160,193,128},{129,178, 94},{ 95,162, 65},{ 39,132, 46},{ 12, 58, 24},{  9, 21, 15},
    {187,224,163},{168,218,142},{143,210,107},{104,201, 84},{ 69,184, 72},{ 31,153, 57},{ 13, 83, 29},{  6, 23,  9}};

void processFrame(int v){
    go = 1;
}

void scuicide(int v){
    exit(0);
}

int main(int argc,char **argv){

    int child = fork();
    signal(SIGRTMIN,processFrame);
    signal(SIGCHLD,scuicide);

    for(unsigned char l = 0; l < 120 ; l++)
        for(unsigned char i = 0 ; i < 120 ; i++)
            frame[l][i] = l+i;

    if(child){ // Parent aka GPU
        while(1){
            usleep(20000);
            kill(child,SIGRTMIN);
        }
        exit(0);
    }else{ // Child aka CPU

        CImgDisplay main_window(120,120,"Braun Fighters",0);
        while(!main_window.is_closed()){

            for(unsigned char l = 0; l < 120 ; l++)
                for(unsigned char i = 0 ; i < 120 ; i++)
                    frame[l][i]++;

            while(!go);

            CImg<> img(main_window.window_width(),main_window.window_height(),1,3);
            if(main_window.is_resized()) main_window.resize(CImg<>(main_window.window_width(),main_window.window_height(),1,3));
            for(int i = 0; i < main_window.window_height(); i++)
                for(int j = 0; j < main_window.window_width(); j++){
                    unsigned char x = ((float)i / main_window.window_height()) * 120;
                    unsigned char y = ((float)j / main_window.window_width()) * 120;
                    img.draw_point(j,i,colors[frame[y][x]],0.5);
                }
            main_window.display(img);

            go = 0;
        }

        exit(0);
    }

    return 0;
}
